# 数据库管理工具使用说明

## 概述

本项目提供了两个强大的数据库管理工具：

1. **db_manager.py** - 基础数据库管理工具
2. **migrate_manager.py** - 高级数据库迁移管理工具

## 工具功能对比

| 功能 | db_manager.py | migrate_manager.py |
|------|---------------|-------------------|
| 数据管理 | ✅ | ✅ |
| 表结构管理 | ✅ | ✅ |
| 数据库迁移 | ❌ | ✅ |
| 备份恢复 | ✅ | ✅ |
| 系统工具 | ✅ | ✅ |

## 使用方法

### 1. 基础数据库管理工具 (db_manager.py)

```bash
python3 db_manager.py
```

**主要功能：**

#### 📊 数据管理
- 查看所有用户
- 创建新用户
- 修改用户权限
- 删除用户
- 查看所有文章
- 创建新文章
- 删除文章
- 查看所有项目
- 创建新项目
- 删除项目
- 查看所有消息
- 删除消息
- 数据库统计

#### 🏗️ 数据库结构管理
- 查看所有表
- 查看表结构
- 创建新表
- 给表添加字段
- 删除表
- 数据库迁移
- 备份数据库
- 恢复数据库

#### 🔧 系统工具
- 初始化数据库
- 重置数据库
- 查看数据库信息

### 2. 高级数据库迁移管理工具 (migrate_manager.py)

```bash
python3 migrate_manager.py
```

**主要功能：**

#### 📝 迁移操作
- 初始化迁移环境
- 创建迁移文件
- 查看迁移历史
- 执行迁移
- 回滚迁移
- 升级到指定版本
- 降级到指定版本
- 显示当前版本
- 显示迁移信息

#### 🔧 数据库操作
- 初始化数据库
- 重置数据库
- 备份数据库
- 恢复数据库
- 查看数据库状态

#### 📊 数据管理
- 查看所有表
- 查看表结构
- 创建新表
- 给表添加字段
- 删除表

## 详细功能说明

### 建表功能

1. **选择工具**：运行 `python3 db_manager.py` 或 `python3 migrate_manager.py`
2. **选择功能**：选择 "16. 创建新表" 或 "17. 创建新表"
3. **输入表名**：输入要创建的表名
4. **定义字段**：
   - 字段名：如 `id`, `name`, `email` 等
   - 字段类型：`INTEGER`, `TEXT`, `REAL`, `BLOB`
   - 是否允许为空：`y` 或 `n`
   - 是否为主键：`y` 或 `n`
   - 默认值：可选
5. **确认创建**：查看生成的SQL语句并确认

**示例：**
```
表名: users
字段名: id
字段类型: INTEGER
是否允许为空: n
是否为主键: y
默认值: 

字段名: username
字段类型: TEXT
是否允许为空: n
是否为主键: n
默认值: 

字段名: email
字段类型: TEXT
是否允许为空: n
是否为主键: n
默认值: 

字段名: created_at
字段类型: TEXT
是否允许为空: n
是否为主键: n
默认值: CURRENT_TIMESTAMP
```

### 添加字段功能

1. **选择功能**：选择 "17. 给表添加字段" 或 "18. 给表添加字段"
2. **选择表**：从表列表中选择要添加字段的表
3. **定义字段**：
   - 字段名：新字段的名称
   - 字段类型：`INTEGER`, `TEXT`, `REAL`, `BLOB`
   - 默认值：可选
4. **确认添加**：查看生成的SQL语句并确认

**示例：**
```
表名: users
字段名: phone
字段类型: TEXT
默认值: 
```

### 数据库迁移功能

#### 初始化迁移环境
```bash
flask db init
```

#### 创建迁移文件
```bash
flask db migrate -m "描述信息"
```

#### 执行迁移
```bash
flask db upgrade
```

#### 回滚迁移
```bash
flask db downgrade
```

#### 查看迁移历史
```bash
flask db history
```

#### 查看当前版本
```bash
flask db current
```

### 备份和恢复功能

#### 备份数据库
- 自动创建带时间戳的备份文件
- 备份文件格式：`database.db.backup_YYYYMMDD_HHMMSS`

#### 恢复数据库
- 列出所有可用的备份文件
- 选择要恢复的备份文件
- 确认恢复操作

### 系统工具功能

#### 初始化数据库
- 创建所有必要的表
- 创建默认管理员用户
- 用户名：`admin`
- 密码：`admin123`

#### 重置数据库
- 删除所有表和数据
- 重新创建表结构
- 创建默认管理员用户

#### 查看数据库信息
- 数据库文件路径
- 文件大小
- 最后修改时间
- 表数量和行数统计

## 注意事项

1. **备份重要**：在进行任何数据库操作前，建议先备份数据库
2. **权限检查**：确保对数据库文件有读写权限
3. **数据安全**：删除操作不可恢复，请谨慎操作
4. **迁移环境**：使用迁移功能前需要先初始化迁移环境

## 错误处理

### 常见错误及解决方案

1. **数据库文件不存在**
   - 解决方案：先运行初始化数据库功能

2. **权限不足**
   - 解决方案：检查文件权限，确保有读写权限

3. **表已存在**
   - 解决方案：先删除表或使用不同的表名

4. **字段已存在**
   - 解决方案：使用不同的字段名或先删除字段

## 高级用法

### 自定义SQL执行

如果需要执行自定义SQL语句，可以：

1. 使用数据库管理工具查看表结构
2. 根据表结构编写SQL语句
3. 使用SQLite命令行工具执行

### 批量操作

对于大量数据操作，建议：

1. 使用备份功能保护数据
2. 编写脚本批量处理
3. 使用事务确保数据一致性

### 性能优化

1. **索引优化**：为常用查询字段添加索引
2. **查询优化**：避免全表扫描
3. **定期维护**：定期清理无用数据

## 联系支持

如果遇到问题，请：

1. 查看错误信息
2. 检查数据库文件权限
3. 确认SQL语句语法
4. 查看日志文件

---

*最后更新：2025年1月* 