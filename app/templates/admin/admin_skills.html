{% extends "base.html" %}

{% block title %}技能管理 - 管理后台{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-code"></i> 技能管理</h1>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="refreshSkills()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                    <a href="{{ url_for('admin.new_skill') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 新建技能
                    </a>
                </div>
            </div>
            
            <!-- 筛选器 -->
            <div id="skillFilters" class="card mb-4" style="display: none;">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="skillSearch" class="form-label">搜索技能</label>
                            <input type="text" class="form-control" id="skillSearch" name="search" 
                                   placeholder="搜索技能名称或描述..." value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="col-md-3">
                            <label for="skillStatus" class="form-label">状态筛选</label>
                            <select class="form-select" id="skillStatus" name="status">
                                <option value="">全部状态</option>
                                <option value="active" {{ 'selected' if request.args.get('status') == 'active' }}>启用</option>
                                <option value="inactive" {{ 'selected' if request.args.get('status') == 'inactive' }}>禁用</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="skillCategory" class="form-label">分类筛选</label>
                            <select class="form-select" id="skillCategory" name="category">
                                <option value="">全部分类</option>
                                {% for skill in skills.items if skills %}
                                {% if skill.category %}
                                <option value="{{ skill.category }}" {{ 'selected' if request.args.get('category') == skill.category }}>
                                    {{ skill.category }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                            <a href="{{ url_for('admin.admin_skills') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> 清除
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 技能列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list"></i> 技能列表</h5>
                    <div class="text-muted">
                        共 {{ skills.total if skills else 0 }} 个技能
                    </div>
                </div>
                
                <div class="card-body">
                {% if skills.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>排序</th>
                                <th>图标</th>
                                <th>技能名称</th>
                                <th>分类</th>
                                <th>熟练度</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for skill in skills.items %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ skill.sort_order }}</span>
                                </td>
                                <td>
                                    {% if skill.icon %}
                                        {% if skill.icon.startswith('http') %}
                                            <img src="{{ skill.icon }}" alt="{{ skill.name }}" class="rounded" style="width: 24px; height: 24px; object-fit: cover;">
                                        {% else %}
                                            <i class="{{ skill.icon }}" style="font-size: 24px; color: #007bff;"></i>
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-code" style="font-size: 24px; color: #6c757d;"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ skill.name }}</strong>
                                        {% if skill.description %}
                                        <div class="text-muted small">{{ skill.description[:50] }}{% if skill.description|length > 50 %}...{% endif %}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if skill.category %}
                                    <span class="badge bg-info">{{ skill.category }}</span>
                                    {% else %}
                                    <span class="text-muted">未分类</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="width: 80px; height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ skill.proficiency }}%" 
                                             aria-valuenow="{{ skill.proficiency }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            {{ skill.proficiency }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if skill.is_active %}
                                        <span class="badge bg-success">启用</span>
                                    {% else %}
                                        <span class="badge bg-secondary">禁用</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ skill.created_at.strftime('%Y-%m-%d') }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('admin.edit_skill', skill_id=skill.id) }}" 
                                           class="btn btn-outline-primary" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteSkill({{ skill.id }}, '{{ skill.name }}')" 
                                                title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                {% if skills.pages > 1 %}
                <nav aria-label="技能分页">
                    <ul class="pagination justify-content-center">
                        {% if skills.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.admin_skills', page=skills.prev_num) }}">
                                <i class="fas fa-chevron-left"></i> 上一页
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in skills.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != skills.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.admin_skills', page=page_num) }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if skills.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.admin_skills', page=skills.next_num) }}">
                                下一页 <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-code fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无技能</h5>
                    <p class="text-muted">还没有添加任何技能，点击上方按钮创建第一个技能吧！</p>
                    <a href="{{ url_for('admin.new_skill') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 新建技能
                    </a>
                </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 卡片背景透明化 */
.card {
    background: transparent !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(10px);
    box-shadow: none !important;
}

.card-header {
    background: rgba(15, 23, 42, 0.3) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #e2e8f0 !important;
}

.card-body {
    background: transparent !important;
    color: #94a3b8 !important;
}

/* 表格背景透明化 */
.table {
    background: transparent !important;
    color: #94a3b8 !important;
}

.table thead th {
    background: rgba(15, 23, 42, 0.2) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #e2e8f0 !important;
}

.table tbody tr {
    background: transparent !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
}

.table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05) !important;
}

.table td {
    background: transparent !important;
    border: none !important;
    color: #94a3b8 !important;
}

/* 统计卡片背景透明化 */
.bg-primary, .bg-success, .bg-info, .bg-warning {
    background: rgba(15, 23, 42, 0.3) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(10px);
}

/* 表单控件透明化 */
.form-control, .form-select {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.form-control:focus, .form-select:focus {
    background: rgba(255, 255, 255, 0.15) !important;
    border-color: rgba(255, 255, 255, 0.4) !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25) !important;
    color: white !important;
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.6) !important;
}

.form-label {
    color: white !important;
}

/* 按钮透明化 */
.btn-outline-secondary, .btn-outline-primary {
    background: transparent !important;
    border-color: rgba(255, 255, 255, 0.3) !important;
    color: white !important;
}

.btn-outline-secondary:hover, .btn-outline-primary:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    border-color: rgba(255, 255, 255, 0.5) !important;
    color: white !important;
}

/* 徽章透明化 */
.badge {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.badge.bg-primary {
    background: rgba(13, 110, 253, 0.3) !important;
}

.badge.bg-success {
    background: rgba(25, 135, 84, 0.3) !important;
}

.badge.bg-secondary {
    background: rgba(108, 117, 125, 0.3) !important;
}

.badge.bg-info {
    background: rgba(13, 202, 240, 0.3) !important;
}

/* 进度条透明化 */
.progress {
    background: rgba(255, 255, 255, 0.1) !important;
}

.progress-bar {
    background: linear-gradient(90deg, #10b981, #059669) !important;
}

/* 链接透明化 */
a {
    color: #60a5fa !important;
}

a:hover {
    color: #93c5fd !important;
}

/* 文本颜色调整 */
.text-muted {
    color: rgba(255, 255, 255, 0.6) !important;
}

/* 分页透明化 */
.pagination .page-link {
    background: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.pagination .page-link:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    border-color: rgba(255, 255, 255, 0.3) !important;
    color: white !important;
}

.pagination .page-item.active .page-link {
    background: #007bff !important;
    border-color: #007bff !important;
    color: white !important;
}

.pagination .page-item.disabled .page-link {
    background: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: rgba(255, 255, 255, 0.3) !important;
}
</style>

<script>
// 删除功能
function deleteSkill(skillId, skillName) {
    if (confirm(`确定要删除技能 "${skillName}" 吗？此操作不可撤销。`)) {
        fetch(`/admin/skills/${skillId}/delete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('删除技能失败:', error);
            showMessage('删除失败，请稍后重试', 'error');
        });
    }
}

// 筛选器切换
function toggleFilters() {
    const filters = document.getElementById('skillFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// 刷新功能
function refreshSkills() {
    location.reload();
}

// 消息提示功能
function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 300px;
        word-wrap: break-word;
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 如果有搜索参数，显示筛选器
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('search') || urlParams.get('status') || urlParams.get('category')) {
        document.getElementById('skillFilters').style.display = 'block';
    }
});
</script>
{% endblock %}
